<html>

<head>
	<title>Navb Exporter</title>
	<meta charset="UTF-8">
</head>
<body>
	<input type="file" id="file-upload" />
	<ul id="upload-event-list"></ul>
	<script>
		function parseCsv(result, delimiter = ",") {
			window.result = result
			const [heading, ...rows] = result.replace(/\"/g, "").split("\n")

			const parsedHeading = heading.split(delimiter)
			const parsedData = []

			const parsedRows = rows.map(row => row.split(delimiter)).map(row => {
				const rowObject = {};
				parsedHeading.forEach((heading, index) => {
					rowObject[heading] = row[index]
				})

				return rowObject
			})
			return parsedRows
		}

		function generateCsv(array, delimiter = ";") {
			const heading = Object.keys(array[0]).join(delimiter)
			return [heading].concat(array.map(row => Object.values(row).join(delimiter))).join("\n")
		}

		function groupBy(array, key) {
			return array.reduce((acc, cur) => {
				if (acc[cur[key]]) {
					acc[cur[key]].push(cur)
					return acc
				} else {
					return {...acc, [cur[key]]: [cur] }
				}
			}, {})
		}

		const list = document.getElementById("upload-event-list")
		const fileUpload = document.getElementById("file-upload")

		let orders = null

		function capitalize(input) {
			if (input && input.length > 0)
				return input[0].toUpperCase() + input.slice(1, input.length).toLowerCase()
				
			return input
		}


		function exportToNavb(data) {
			const csv = generateCsv(data.map(order => {
				const formattedDate = new Intl.DateTimeFormat("nl").format(new Date(order["Geboortedatum (dd-mm-jjjj)"]))
				const addressLine = order["Adres (Straat + huisnummer)"].split(" ")
				const houseNumber = addressLine[addressLine.length - 1]
				const street = addressLine.slice(0, addressLine.length - 1).join(" ")
				return {
					"tussenvoegsel": order["Naam (Tussenvoegsel)"],
					"achternaam": capitalize(order["Naam (Achternaam)"]),
					"voornaam": capitalize(order["Naam (Voornaam)"]),
					"geboortedatum (dd-mm-jjjj)": formattedDate,
					"postcode": order["Adres (Postcode)"].toUpperCase(),
					"straat": street,
					"huisnummer": houseNumber,
					"huisnummer toevoeging": "",
					"stad": capitalize(order["Adres (Stad)"]),
					"E-mailadres": order["E-mailadres"]
				}
			}))
			const element = document.createElement('a');
    			element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
    			element.setAttribute('download', "navbexport.csv");
    			element.style.display = 'none';
    			document.body.appendChild(element);

    			element.click();

    			document.body.removeChild(element);
		}

		fileUpload.addEventListener("change", e => {
			e.target.files[0].text().then(result => {
				const parsedRows = parseCsv(result);
				window.rows = parsedRows
				e.target.style.display = "none"

				orders = groupBy(parsedRows, "Bestelnummer")

				Object.entries(orders).forEach(([key, values]) => {
					const row = document.createElement("li")
					
					row.innerHTML = `
						<p>Bestelnummer: ${key}, totaal participanten: ${values.length}</p>
						<button id="${key}">export bestelling naar NAVB formaat</button
					`
					list.appendChild(row)
					document.getElementById(key).addEventListener("click", value => exportToNavb(orders[value.target.id]))
				})
			})
		})
	</script>
</body>
