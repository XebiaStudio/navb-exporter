<html>

<head>
	<title>Navb Exporter</title>
	<meta charset="UTF-8">
</head>
<body>
	<input type="file" id="file-upload" />
	<ul id="upload-event-list"></ul>
	<script>
		function parseCsv(result) {
			window.result = result
			const [heading, ...rows] = result.replace(/\"/g, "").split("\n")

			const parsedHeading = heading.split(",")
			const parsedData = []

			const parsedRows = rows.map(row => row.split(",")).map(row => {
				const rowObject = {};
				parsedHeading.forEach((heading, index) => {
					rowObject[heading] = row[index]
				})

				return rowObject
			})
			return parsedRows
		}

		function groupBy(array, key) {
			return array.reduce((acc, cur) => {
				if (acc[cur[key]]) {
					acc[cur[key]].push(cur)
					return acc
				} else {
					return {...acc, [cur[key]]: [cur] }
				}
			}, {})
		}

		const list = document.getElementById("upload-event-list")
		const fileUpload = document.getElementById("file-upload")

		let orders = null

		fileUpload.addEventListener("change", e => {
			e.target.files[0].text().then(result => {
				const parsedRows = parseCsv(result);
				window.rows = parsedRows
				e.target.style.display = "none"

				orders = groupBy(parsedRows, "Bestelnummer")

				Object.entries(orders).forEach(([key, values]) => {
					const row = document.createElement("li")
					
					row.innerHTML = `
						<p>Bestelnummer: ${key}, totaal participanten: ${values.length}</p>
						<button id="${key}">export bestelling naar NAVB formaat</button
					`
					list.appendChild(row)
				})
			})
		})
	</script>
</body>
